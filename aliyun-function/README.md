# 阿里云函数部署指南

## 目录
1. [函数代码说明](#函数代码说明)
2. [部署步骤](#部署步骤)
3. [测试方法](#测试方法)
4. [常见问题](#常见问题)

## 函数代码说明

### 功能
- 代理请求水文数据API
- 支持GET请求参数
- 自动处理跨域请求
- 完善的错误处理
- 详细的日志记录

### 代码结构
- `index.js` - 主函数代码

### 依赖
- 无外部依赖，使用Node.js内置模块

## 部署步骤

### 方法一：通过ZIP包上传

1. **创建ZIP文件**
   - 选择 `index.js` 文件
   - 压缩为 `hydrological-proxy.zip`

2. **登录阿里云控制台**
   - 访问 https://console.aliyun.com
   - 进入函数计算服务

3. **创建函数**
   - 点击"创建函数"
   - 选择"使用内置运行时创建"
   - 运行时选择 `Node.js 18`
   - 函数名称：`fetch-hydrological-data`
   - 代码上传方式："通过ZIP包上传"
   - 上传 `hydrological-proxy.zip`
   - 点击"创建"

4. **配置HTTP触发器**
   - 在函数详情页，点击"触发器"
   - 点击"创建触发器"
   - 触发器类型："HTTP触发器"
   - 触发器名称：`http-trigger`
   - 请求方式：勾选 `GET`
   - 认证方式：选择 `匿名`
   - 点击"确定"

5. **获取访问地址**
   - 在触发器列表中，复制"公网访问地址"

### 方法二：在线编辑

1. **登录阿里云控制台**
   - 访问 https://console.aliyun.com
   - 进入函数计算服务

2. **创建函数**
   - 点击"创建函数"
   - 选择"使用内置运行时创建"
   - 运行时选择 `Node.js 18`
   - 函数名称：`fetch-hydrological-data`
   - 代码上传方式："在线编辑"

3. **粘贴代码**
   - 在代码编辑器中，删除默认代码
   - 复制 `index.js` 的内容粘贴进去
   - 点击"部署"

4. **配置HTTP触发器**
   - 按照方法一的步骤4操作

5. **获取访问地址**
   - 按照方法一的步骤5操作

## 测试方法

### 方法一：阿里云控制台测试

1. **进入测试页面**
   - 函数详情页 → 测试

2. **配置测试参数**
   - 请求方式：`GET`
   - 查询参数：
     - code: `613K0912`
     - dateBegin: `2026-01-27+14`
     - dateEnd: `2026-01-29+14`

3. **执行测试**
   - 点击"执行测试"
   - 查看执行结果

### 方法二：curl测试

```bash
curl -X GET "YOUR_FUNCTION_URL?code=613K0912&dateBegin=2026-01-27+14&dateEnd=2026-01-29+14"
```

### 方法三：浏览器测试

在浏览器地址栏中输入：
```
YOUR_FUNCTION_URL?code=613K0912&dateBegin=2026-01-27+14&dateEnd=2026-01-29+14
```

### 方法四：小程序测试

1. **配置小程序**
   - 修改 `weixin-app/app.js` 中的 `PROXY_URL` 为你的函数URL
   - 在微信公众平台添加合法域名

2. **编译运行**
   - 打开微信开发者工具
   - 点击"编译"
   - 查看控制台日志

## 常见问题

### 1. 函数调用失败

**错误信息**：`Function not found`

**解决方案**：
- 检查函数名称是否正确
- 确认函数已成功部署
- 检查地域是否匹配

### 2. 参数错误

**错误信息**：`缺少必要参数: code, dateBegin, dateEnd`

**解决方案**：
- 确保所有必要参数都已提供
- 检查参数名称是否正确
- 验证参数值格式是否正确

### 3. API请求失败

**错误信息**：`API请求失败` 或 `API请求超时`

**解决方案**：
- 检查目标API是否正常（http://www.hnswkcj.com）
- 确认网络连接正常
- 增加函数超时时间（最长60秒）

### 4. 响应格式错误

**错误信息**：`Unexpected token < in JSON at position 0`

**解决方案**：
- 查看函数日志，确认API返回数据格式
- 检查目标API是否返回HTML错误页面
- 验证参数是否正确

### 5. 小程序访问失败

**错误信息**：`request:fail url not in domain list`

**解决方案**：
- 在微信公众平台添加合法域名
- 等待5-10分钟让配置生效
- 重新编译小程序

## 日志查看

1. **登录控制台**
   - 函数详情页 → 监控与日志 → 日志查询

2. **查看日志**
   - 选择时间范围
   - 查看函数执行日志
   - 分析错误原因

## 性能优化

1. **缓存机制**：
   - 对于频繁请求的数据，可以添加内存缓存
   - 设置合理的缓存过期时间

2. **超时设置**：
   - 根据实际API响应时间调整超时设置
   - 避免过长的超时时间影响用户体验

3. **错误处理**：
   - 完善的错误处理机制
   - 详细的日志记录

## 注意事项

1. **安全**：函数使用匿名访问，请确保不会被滥用
2. **费用**：阿里云函数计算有免费额度，超出后会收费
3. **配额**：注意函数调用频率和并发限制
4. **监控**：定期查看函数执行情况和日志

## 联系信息

如有问题，请联系：
- 阿里云技术支持
- 查看阿里云函数计算文档：https://help.aliyun.com/zh/functioncompute/