# 阿里云函数计算详细部署指南

## 目录
1. [准备工作](#准备工作)
2. [注册阿里云账号](#注册阿里云账号)
3. [开通函数计算服务](#开通函数计算服务)
4. [创建函数](#创建函数)
5. [上传代码](#上传代码)
6. [配置HTTP触发器](#配置http触发器)
7. [获取访问地址](#获取访问地址)
8. [配置小程序](#配置小程序)
9. [测试验证](#测试验证)
10. [常见问题](#常见问题)

---

## 准备工作

在开始之前，请确保您已准备好：
- ✅ 阿里云账号（如果没有，请注册）
- ✅ 手机号码（用于验证）
- ✅ 支付宝或银行卡（用于实名认证）
- ✅ 本地代码文件：`aliyun-function/index.js`

---

## 注册阿里云账号

### 步骤1：访问阿里云官网
打开浏览器，访问：https://www.aliyun.com

### 步骤2：注册账号
1. 点击右上角"免费注册"
2. 填写手机号码
3. 获取并输入验证码
4. 设置登录密码
5. 点击"注册"

### 步骤3：实名认证（必须）
1. 登录后，点击右上角头像
2. 选择"实名认证"
3. 选择"个人认证"或"企业认证"
4. 按照提示完成认证（需要上传身份证照片或企业证件）
5. 等待审核（通常1-2小时）

**注意**：实名认证是必须的步骤，否则无法使用云服务。

---

## 开通函数计算服务

### 步骤1：进入函数计算控制台
1. 登录阿里云控制台：https://console.aliyun.com
2. 在搜索框中输入"函数计算"
3. 点击"函数计算"进入服务页面

### 步骤2：开通服务
1. 如果是第一次使用，点击"立即开通"
2. 阅读并同意服务协议
3. 点击"立即开通"

### 步骤3：选择地域
函数计算支持多个地域，推荐选择：
- **华东1（杭州）** - 推荐国内用户使用
- **华东2（上海）** - 推荐华东地区用户
- **华北2（北京）** - 推荐华北地区用户
- **华南1（深圳）** - 推荐华南地区用户

**建议**：选择距离您用户最近的地域，延迟更低。

---

## 创建函数

### 步骤1：进入函数管理页面
1. 在函数计算控制台左侧菜单中，点击"服务及函数"
2. 点击"创建服务"（如果还没有服务）

### 步骤2：创建服务
1. **服务名称**：输入服务名称，例如 `hydrological-service`
2. **描述**：可选，例如 `水文数据代理服务`
3. **日志服务**：选择"启用"（推荐，方便调试）
4. **角色配置**：选择"创建新角色"或"使用已有角色"
5. 点击"确定"

### 步骤3：创建函数
1. 在服务页面，点击"创建函数"
2. 选择"使用内置运行时创建"
3. 点击"下一步"

### 步骤4：配置函数基本信息
1. **函数名称**：输入函数名称，例如 `fetch-hydrological-data`
2. **请求处理程序**：保持默认 `index.handler`
3. **运行时**：选择 `Node.js 14` 或 `Node.js 16`
4. **函数代码**：选择"在线编辑"
5. **函数代码**：将 `aliyun-function/index.js` 的内容复制粘贴到编辑器中

**代码内容**：
```javascript
const request = require('request-promise');

exports.handler = async (event, context) => {
  const { code, dateBegin, dateEnd } = event;
  
  const apiUrl = `http://www.hnswkcj.com/wxhn/data/rthyinfo/rsvr/proc/one.json?code=${code}&dateBegin=${dateBegin}&dateEnd=${dateEnd}`;
  
  try {
    const result = await request({
      uri: apiUrl,
      json: true,
      timeout: 10000
    });
    
    return {
      statusCode: 200,
      body: JSON.stringify(result),
      headers: {
        'Content-Type': 'application/json'
      }
    };
  } catch (error) {
    return {
      statusCode: 500,
      body: JSON.stringify({ error: error.message })
    };
  }
};
```

### 步骤5：配置函数高级设置
1. **内存规格**：选择 `128 MB`（足够使用）
2. **超时时间**：设置为 `10` 秒
3. **实例并发度**：保持默认 `1`
4. 点击"创建"

---

## 上传代码

### 方法一：在线编辑（推荐新手）

1. 在函数详情页，点击"代码"标签
2. 在代码编辑器中粘贴 `index.js` 的内容
3. 点击"保存并部署"

### 方法二：上传ZIP包（推荐有经验的用户）

#### 步骤1：准备代码包
1. 在本地创建文件夹 `hydrological-function`
2. 将 `index.js` 复制到文件夹中
3. 在文件夹中创建 `package.json`：

```json
{
  "name": "hydrological-function",
  "version": "1.0.0",
  "description": "Fetch hydrological data",
  "main": "index.js",
  "dependencies": {
    "request-promise": "^4.2.6"
  }
}
```

#### 步骤2：安装依赖
```bash
cd hydrological-function
npm install
```

#### 步骤3：打包
```bash
# Windows
Compress-Archive -Path * -DestinationPath hydrological-function.zip

# Linux/Mac
zip -r hydrological-function.zip *
```

#### 步骤4：上传
1. 在函数详情页，点击"代码"标签
2. 点击"上传代码"
3. 选择"上传ZIP包"
4. 选择 `hydrological-function.zip`
5. 点击"确定"

---

## 配置HTTP触发器

### 步骤1：进入触发器管理
1. 在函数详情页，点击"触发器管理"标签
2. 点击"创建触发器"

### 步骤2：配置触发器
1. **触发器类型**：选择"HTTP触发器"
2. **触发器名称**：输入名称，例如 `http-trigger`
3. **请求方式**：勾选 `GET` 和 `POST`
4. **认证方式**：选择 `anonymous`（匿名访问）
5. **请求路径**：保持默认 `/`
6. 点击"确定"

### 步骤3：记录访问地址
创建成功后，会显示一个类似这样的URL：
```
https://1234567890123456.cn-hangzhou.fc.aliyuncs.com/2016-08-15/proxy/hydrological-service/fetch-hydrological-data/
```

**重要**：请复制并保存这个URL，后面配置小程序时会用到。

---

## 获取访问地址

### 方法一：从触发器管理页面获取
1. 在函数详情页，点击"触发器管理"标签
2. 找到刚创建的HTTP触发器
3. 点击"公网访问地址"列中的链接
4. 复制完整的URL

### 方法二：从函数测试页面获取
1. 在函数详情页，点击"测试函数"标签
2. 在"触发器事件"下拉框中选择刚创建的HTTP触发器
3. 复制显示的URL

### URL格式说明
完整的URL格式如下：
```
https://<account-id>.<region>.fc.aliyuncs.com/2016-08-15/proxy/<service-name>/<function-name>/
```

例如：
```
https://1234567890123456.cn-hangzhou.fc.aliyuncs.com/2016-08-15/proxy/hydrological-service/fetch-hydrological-data/
```

**注意**：请确保URL以 `/` 结尾。

---

## 配置小程序

### 步骤1：修改 app.js
打开 `weixin-app/app.js`，修改 `PROXY_URL`：

```javascript
globalData: {
  // 核心配置
  BASE_URL: "http://www.hnswkcj.com/wxhn/data/rthyinfo/rsvr/proc/one.json",
  PROXY_URL: "https://1234567890123456.cn-hangzhou.fc.aliyuncs.com/2016-08-15/proxy/hydrological-service/fetch-hydrological-data/",
  STATION_CODE: "613K0912",
  STATION_NAME: "中方县铜湾水库",
  // ... 其他配置
}
```

**注意**：将 `PROXY_URL` 替换为您实际的阿里云函数URL。

### 步骤2：配置合法域名
1. 登录 [微信公众平台](https://mp.weixin.qq.com)
2. 进入小程序后台
3. 点击"开发" → "开发管理" → "开发设置"
4. 在"服务器域名"的"request合法域名"中添加：
   ```
   *.fc.aliyuncs.com
   ```

**注意**：
- 必须添加 `*.fc.aliyuncs.com`，否则小程序无法访问
- 每月只能修改5次，请谨慎操作
- 域名配置后可能需要几分钟生效

### 步骤3：重新编译小程序
1. 打开微信开发者工具
2. 点击"编译"按钮
3. 查看控制台日志，确认请求成功

---

## 测试验证

### 方法一：在阿里云控制台测试

#### 步骤1：进入测试页面
1. 在函数详情页，点击"测试函数"标签
2. 在"触发器事件"下拉框中选择HTTP触发器

#### 步骤2：配置测试参数
1. 点击"配置测试参数"
2. 在"事件"文本框中输入测试数据：

```json
{
  "code": "613K0912",
  "dateBegin": "2025-12-29+14",
  "dateEnd": "2025-12-31+14"
}
```

3. 点击"确定"

#### 步骤3：执行测试
1. 点击"测试函数"
2. 查看执行结果
3. 成功时会返回水文数据

### 方法二：使用curl命令测试

```bash
curl -X GET "https://1234567890123456.cn-hangzhou.fc.aliyuncs.com/2016-08-15/proxy/hydrological-service/fetch-hydrological-data/?code=613K0912&dateBegin=2025-12-29+14&dateEnd=2025-12-31+14"
```

### 方法三：在小程序中测试

1. 打开微信开发者工具
2. 编译并运行小程序
3. 查看控制台日志
4. 确认数据加载成功

---

## 常见问题

### 问题1：函数创建失败

**错误信息**：`创建函数失败`

**解决方案**：
1. 检查代码语法是否正确
2. 确认运行时版本是否正确
3. 检查是否已开通函数计算服务
4. 确认账户已实名认证

### 问题2：触发器创建失败

**错误信息**：`创建触发器失败`

**解决方案**：
1. 确认函数已成功创建
2. 检查触发器名称是否重复
3. 确认账户余额充足

### 问题3：小程序无法访问函数

**错误信息**：`request:fail url not in domain list`

**解决方案**：
1. 在微信公众平台配置合法域名：`*.fc.aliyuncs.com`
2. 确认URL格式正确
3. 等待域名配置生效（可能需要几分钟）

### 问题4：函数调用超时

**错误信息**：`Task timed out after 10.00 seconds`

**解决方案**：
1. 增加函数超时时间（在函数配置中修改）
2. 检查目标API是否响应正常
3. 优化代码逻辑

### 问题5：返回数据格式错误

**错误信息**：`Unexpected token < in JSON at position 0`

**解决方案**：
1. 检查目标API是否正常返回数据
2. 查看函数日志，确认返回格式
3. 检查代码中的JSON解析逻辑

### 问题6：依赖包安装失败

**错误信息**：`Cannot find module 'request-promise'`

**解决方案**：
1. 确认 `package.json` 配置正确
2. 重新上传代码包
3. 使用在线编辑方式手动添加依赖

---

## 费用说明

### 免费额度
阿里云函数计算提供以下免费额度：
- **每月100万次调用**
- **每月400,000 CU-秒计算资源**
- **每月1 GB公网出流量**

### 计费说明
超出免费额度后，按以下标准计费：
- **调用次数**：¥1.33/百万次
- **执行时间**：¥0.00003167/GB-秒
- **公网出流量**：¥0.50/GB

**估算**：按照当前使用频率，完全在免费额度内，无需付费。

---

## 监控和日志

### 查看调用日志
1. 在函数详情页，点击"日志查询"标签
2. 选择时间范围
3. 查看函数执行日志

### 查看监控指标
1. 在函数详情页，点击"监控信息"标签
2. 查看调用次数、错误率、延迟等指标
3. 可以设置告警规则

---

## 优化建议

### 1. 添加缓存
减少对目标API的调用频率：

```javascript
const cache = {};
const CACHE_TTL = 5 * 60 * 1000; // 5分钟缓存

exports.handler = async (event, context) => {
  const { code, dateBegin, dateEnd } = event;
  const cacheKey = `${code}-${dateBegin}-${dateEnd}`;
  
  if (cache[cacheKey] && Date.now() - cache[cacheKey].timestamp < CACHE_TTL) {
    return cache[cacheKey].data;
  }
  
  // ... 原有代码
  
  cache[cacheKey] = {
    timestamp: Date.now(),
    data: result
  };
  
  return result;
};
```

### 2. 添加错误重试
提高可靠性：

```javascript
const retry = async (fn, retries = 3) => {
  for (let i = 0; i < retries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (i === retries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
};

exports.handler = async (event, context) => {
  const result = await retry(async () => {
    return await request({
      uri: apiUrl,
      json: true,
      timeout: 10000
    });
  });
  
  // ... 后续代码
};
```

### 3. 添加限流
防止滥用：

```javascript
const rateLimit = new Map();

exports.handler = async (event, context) => {
  const clientIP = event.headers['x-forwarded-for'] || 'unknown';
  const now = Date.now();
  
  if (!rateLimit.has(clientIP)) {
    rateLimit.set(clientIP, []);
  }
  
  const requests = rateLimit.get(clientIP).filter(t => now - t < 60000);
  
  if (requests.length > 100) {
    return {
      statusCode: 429,
      body: JSON.stringify({ error: 'Too many requests' })
    };
  }
  
  requests.push(now);
  rateLimit.set(clientIP, requests);
  
  // ... 后续代码
};
```

---

## 总结

### 完整流程回顾
1. ✅ 注册阿里云账号并实名认证
2. ✅ 开通函数计算服务
3. ✅ 创建服务和函数
4. ✅ 上传代码
5. ✅ 配置HTTP触发器
6. ✅ 获取访问地址
7. ✅ 配置小程序
8. ✅ 测试验证

### 关键点
- 📝 记住您的函数访问地址
- 🔐 在微信公众平台配置合法域名
- 💰 免费额度足够个人使用
- 📊 定期查看日志和监控

### 下一步
- 根据实际使用情况优化函数
- 配置告警规则
- 考虑添加更多功能

---

## 技术支持

如有问题，可以：
1. 查看阿里云官方文档：https://help.aliyun.com/product/50980.html
2. 联系阿里云技术支持
3. 查看函数日志排查问题

---

**祝您使用愉快！**
